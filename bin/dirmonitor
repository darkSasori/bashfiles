#!/bin/bash
# El Neuer <lineufelipe@gmail.com>

if [ "$1" == "restart" ]; then
    echo "Restart all"
    for p in $(ps ax |grep dirmonitor |sed 's/\([0-9]\{1,\}\).*/\1/g'); do
        kill -s SIGUSR1 $p
    done
    exit 0
fi;

if [ -z $1 ] || [ -z "$2" ]; then
    echo "usage: $0 directory command"
    exit 0
fi;

DIR=$1
CMD=$2

trap killCommand SIGINT
killCommand() {
    kill -9 $PID
    wait $PID 2>/dev/null
    exit 0
}

trap restartCommand SIGUSR1
restartCommand() {
    kill -9 $PID
    wait $PID 2>/dev/null
    sleep 1
    $CMD &
    PID=$!
}

$CMD &
PID=$!
while [ 1 ]; do
    EVENT=$(inotifywait -q -e MODIFY -e CREATE -e DELETE --format '%e' -t -1  -r $DIR)
    [ $? != 0 ] && exit
    if [ $EVENT == "MODIFY" ] || [ $EVENT == "CREATE" ] || [ $EVENT == "DELETE" ]; then
        restartCommand
    fi
done
